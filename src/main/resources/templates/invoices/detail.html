<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout(~{::content})}">
<body>
<div th:fragment="content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Fattura <span th:text="${invoice.number}"></span></h1>
        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary" th:href="@{/invoices}">Torna alla lista</a>
            <a class="btn btn-primary" th:href="@{/invoices/{id}/edit(id=${invoice.id})}">Modifica testata</a>
        </div>
    </div>

    <div class="row g-3 mb-3">
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header fw-semibold">Dati fattura</div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-md-4"><span class="text-muted">Direzione:</span> <span th:text="${invoice.direction.description}"></span></div>
                        <div class="col-md-4"><span class="text-muted">Stato:</span> <span th:text="${invoice.status.description}"></span></div>
                        <div class="col-md-4"><span class="text-muted">Numero/Anno:</span> <span th:text="${invoice.number + ' / ' + invoice.year}"></span></div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-4"><span class="text-muted">Data:</span> <span th:text="${invoice.issueDate}"></span></div>
                        <div class="col-md-4"><span class="text-muted">Scadenza:</span> <span th:text="${invoice.dueDate}"></span></div>
                        <div class="col-md-4"><span class="text-muted">Controparte:</span> <span th:text="${invoice.counterparty.name}"></span></div>
                    </div>
                    <div th:if="${invoice.notes}" class="mt-2">
                        <span class="text-muted">Note:</span>
                        <p class="mb-0" th:text="${invoice.notes}"></p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header fw-semibold">Totali</div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Imponibile</span>
                        <span th:text="${#numbers.formatDecimal(totals.netTotal, 1, 'COMMA', 2, 'POINT')}"></span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>IVA</span>
                        <span th:text="${#numbers.formatDecimal(totals.vatTotal, 1, 'COMMA', 2, 'POINT')}"></span>
                    </div>
                    <div class="d-flex justify-content-between mb-2 fw-semibold">
                        <span>Totale</span>
                        <span th:text="${#numbers.formatDecimal(totals.grossTotal, 1, 'COMMA', 2, 'POINT')}"></span>
                    </div>
                    <div class="d-flex justify-content-between mb-2" th:if="${totals.withholdingTotal > 0}">
                        <span>Ritenute</span>
                        <span th:text="${#numbers.formatDecimal(totals.withholdingTotal, 1, 'COMMA', 2, 'POINT')}"></span>
                    </div>
                    <div class="d-flex justify-content-between mt-3">
                        <span th:text="${invoice.direction.code == 'PASSIVE' ? 'Totale da pagare' : 'Totale a incassare'}"></span>
                        <span class="fw-bold" th:text="${#numbers.formatDecimal(totals.payableTotal, 1, 'COMMA', 2, 'POINT')}"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header fw-semibold">Righe</div>
        <div class="card-body">
            <div class="table-responsive mb-4">
                <table class="table table-sm align-middle">
                    <thead>
                    <tr>
                        <th>Descrizione</th>
                        <th class="text-end">Imponibile</th>
                        <th>IVA</th>
                        <th>Conto</th>
                        <th>Ritenuta</th>
                        <th class="text-end">Azioni</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${#lists.isEmpty(invoice.lines)}">
                        <td colspan="6" class="text-center text-muted">Nessuna riga inserita</td>
                    </tr>
                    <tr th:each="line : ${invoice.lines}">
                        <td th:text="${line.description}"></td>
                        <td class="text-end" th:text="${#numbers.formatDecimal(line.netAmount, 1, 'COMMA', 2, 'POINT')}"></td>
                        <td>
                            <div th:if="${line.vatCode != null}">
                                <span th:text="${line.vatCode.code}"></span>
                                <small class="text-muted" th:if="${line.vatCode.rate != null}" th:text="${'(' + line.vatCode.rate + '%)'}"></small>
                            </div>
                            <span th:if="${line.vatCode == null}" class="text-muted">-</span>
                        </td>
                        <td>
                            <div th:if="${line.account != null}">
                                <span th:text="${line.account.code}"></span>
                                <small class="text-muted" th:text="${line.account.description}"></small>
                            </div>
                            <span th:if="${line.account == null}" class="text-muted">-</span>
                        </td>
                        <td>
                            <div th:if="${line.withholdingType != null}">
                                <span th:text="${line.withholdingType.code}"></span>
                                <small class="text-muted" th:text="${line.withholdingType.rate != null ? '(' + line.withholdingType.rate + '%)' : ''}"></small>
                            </div>
                            <span th:if="${line.withholdingType == null}" class="text-muted">-</span>
                        </td>
                        <td class="text-end">
                            <div class="d-flex justify-content-end gap-2">
                                <a class="btn btn-sm btn-outline-secondary" th:href="@{/invoices/{id}/lines/{lineId}/edit(id=${invoice.id}, lineId=${line.id})}">Modifica</a>
                                <form th:action="@{/invoices/{id}/lines/{lineId}/delete(id=${invoice.id}, lineId=${line.id})}" method="post" class="d-inline"
                                      th:onsubmit="return confirm('Eliminare questa riga?');">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">Elimina</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <h5 class="h6">Aggiungi riga</h5>
            <form th:action="@{/invoices/{id}/lines(id=${invoice.id})}" th:object="${line}" method="post" class="row g-3">
                <div class="col-md-6">
                    <label class="form-label" for="description">Descrizione</label>
                    <input type="text" class="form-control" id="description" th:field="*{description}" required>
                    <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('description')}" th:errors="*{description}"></div>
                </div>
                <div class="col-md-3">
                    <label class="form-label" for="netAmount">Imponibile</label>
                    <input type="number" step="0.01" min="0.01" class="form-control" id="netAmount" th:field="*{netAmount}" required>
                    <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('netAmount')}" th:errors="*{netAmount}"></div>
                </div>
                <div class="col-md-3">
                    <label class="form-label" for="vatCode">Codice IVA</label>
                    <select class="form-select" id="vatCode" th:field="*{vatCode.id}">
                        <option th:value="">Nessuno</option>
                        <option th:each="v : ${vatCodes}" th:value="${v.id}" th:text="${v.code + ' (' + (v.rate != null ? v.rate + '%' : 'n.d.') + ')'}"></option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label" for="account">Conto</label>
                    <select class="form-select" id="account" th:field="*{account.id}">
                        <option th:value="">Nessuno</option>
                        <option th:each="a : ${accounts}" th:value="${a.id}" th:text="${a.code + ' - ' + a.description}"></option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label" for="withholdingType">Ritenuta</label>
                    <select class="form-select" id="withholdingType" th:field="*{withholdingType.id}">
                        <option th:value="">Nessuna</option>
                        <option th:each="w : ${withholdingTypes}" th:value="${w.id}" th:text="${w.code + ' (' + (w.rate != null ? w.rate + '%' : 'n.d.') + ')'}"></option>
                    </select>
                </div>
                <div class="col-12 d-flex justify-content-end gap-2">
                    <button type="submit" class="btn btn-primary">Aggiungi</button>
                </div>
            </form>
        </div>
    </div>
</div>
</body>
</html>